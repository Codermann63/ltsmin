#!/bin/bash
# Simple bash shell script to launch SpinJa using the LTSmin backend


COMMAND="$(basename "$0")"

# the following variables are initialised by "configure"
LTSMIN_VERSION="@VERSION@"
LTSMIN_PREFIX="@prefix@"
LTSMIN_LIB="@pkglibdir@"

spinja_dir="$LTSMIN_PREFIX/share/ltsmin"

show_usage=
promela_file=
gcc_options=

if [ $# -eq 0 ] ; then
    echo "usage: spinja [gcc_options] promela_file" ;
    echo "options will be passed to GCC"
    exit 1
fi

VERBOSE=0
promela_file=
while (( $# > 0 )); do
    if [ "$1" == "-s" ]; then
        SKIP_SPINJA="1";
    elif [ "${1}" == "-v" ]; then
        OPTIONS="$OPTIONS $1"
        VERBOSE=1
    elif [ "${1:0:1}" == "-" ]; then
        OPTIONS="$OPTIONS $1"
    else
		promela_file=$1
    fi
    shift;
done

#while [ $# -gt 1 ] ; do
#    gcc_options="$gcc_options $1"
#    shift
#done

promela_name=`basename $promela_file`
output_file="${promela_name}.spinja.c"

if [ "$SKIP_SPINJA" != "1" ]; then
	if [ -f "$output_file" ]; then
		rm -f "$output_file";
	fi
	
	java -Xms120m -ea:spinja... -Xmx2048m -cp "$spinja_dir/spinja.jar" spinja.Compile -l $OPTIONS $promela_file
	ERROR=$?
    if [ $ERROR -ne 0 ]; then
		echo "Compilation of $promela_file failed"
		exit $ERROR;
	fi
else
	echo "Skipping compilation...";
fi

gcc -pthread -fPIC -shared $output_file -o $promela_name.spinja -O0 -g $gcc_options
if [ $VERBOSE = 1 ]; then
    echo gcc -pthread -fPIC -shared $output_file -o $promela_name.spinja -O0 -g $gcc_options
fi
if [ ! $? -eq 0 ]; then
	echo "Compilation of $output_file failed"
else
	echo "Compiled C model to $promela_name.spinja"
fi
