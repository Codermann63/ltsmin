#!/bin/bash
# Simple bash shell script to launch SpinJa using the LTSmin backend


COMMAND="$(basename "$0")"

# the following variables are initialised by "configure"
LTSMIN_VERSION="@VERSION@"
LTSMIN_PREFIX="@prefix@"
LTSMIN_LIB="@pkglibdir@"

spinja_dir="$LTSMIN_PREFIX/share/ltsmin"

CP="$spinja_dir/spinja.jar"
promela_file=
no_compile=0

for option in ${1+"$@"}; do
    if [ "${option:0:2}" == "-I" ]; then
        no_compile=1
    elif [ "${option:0:1}" != "-" ]; then
        promela_file="$option"
    fi
done

if [ -z "$promela_file" ]; then
    echo "usage: spinja [options] promela_file" ;
    echo "options will be passed to GCC"
    exit 1
fi

promela_name=`basename $promela_file`
output_file="${promela_name}.spinja.c"

if [ -f "$output_file" ]; then
    rm -f "$output_file";
fi

java -Xss8M -Xms120m -Xmx2048m -cp $CP spinja.Compile -l ${1+"$@"}
ERROR=$?
if [ $ERROR -ne 0 ]; then
    echo "Compilation of $promela_file failed"
    exit $ERROR;
fi

if [ $no_compile == 1 ]; then
    echo
    exit 0
fi

gcc -fPIC -shared -O2 -ggdb $CFLAGS $output_file -o $promela_name.spinja
if [ ! $? -eq 0 ]; then
    echo "Compilation of $output_file failed"
else
    echo "Compiled C model to $promela_name.spinja"
fi
